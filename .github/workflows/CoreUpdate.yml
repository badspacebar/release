name: CoreUpdate

on:
  push:
    paths:
      - 'files/proxy.dll'
      - 'files/Proxy.dll'

jobs:
  CoreUpdate_Check_and_Generate_md5:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v2

    - name: é‡å‘½åæ–‡ä»¶
      run: |
        if [[ -f "files/Proxy.dll" ]]; then
          mv files/Proxy.dll files/proxy.dll
        fi

    - name: æ£€æŸ¥æ–‡ä»¶å¤§å°
      run: |
        # è·å–æ–‡ä»¶å¤§å°
        filesize=$(stat --printf="%s" files/proxy.dll)
        if [[ $filesize -gt 15728640 ]]; then
          echo "ğŸ“¦ proxy.dll æ–‡ä»¶å¤§äº 15MBï¼Œå‡†å¤‡è®¡ç®— MD5ã€‚"
          echo "PROCEED=true" >> $GITHUB_ENV
        else
          echo "âŒ proxy.dll æ–‡ä»¶ä¸è¶…è¿‡ 15MBï¼Œé€€å‡ºæµç¨‹ã€‚"
          echo "PROCEED=false" >> $GITHUB_ENV
        fi

    - name: è®¡ç®— MD5 å¹¶è¾“å‡ºåˆ° core æ–‡ä»¶
      if: env.PROCEED == 'true'
      run: |
        # è®¡ç®—æ–‡ä»¶çš„ MD5
        md5=$(md5sum files/proxy.dll | awk '{ print $1 }')
        echo "âœ… æ–‡ä»¶çš„ MD5 å€¼ä¸º: $md5"
        echo $md5 > core

    - name: æäº¤å¹¶æ¨é€ MD5 æ›´æ–°
      if: env.PROCEED == 'true'
      run: |
        current_datetime=$(date '+%Y-%m-%d %H:%M:%S')
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add core.json files/proxy.dll
        git commit -m "ä½¿ç”¨ MD5 å“ˆå¸Œå€¼æ›´æ–° core æ–‡ä»¶ - $current_datetime"
        git push https://${{ secrets.GITHUB_TOKEN }}@github.com/WizisCool/KiKHanbot.git
