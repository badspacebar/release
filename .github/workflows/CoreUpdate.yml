name: æ ¸å¿ƒæ›´æ–° ğŸ”„

on:
  push:
    paths:
      - '**/proxy.dll'
      - '**/Proxy.dll'
  workflow_dispatch:   
jobs:
  check_and_generate_md5:
    runs-on: ubuntu-latest
    steps:
    # ç¬¬1æ­¥: æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»“åº“ ğŸ“¦
      uses: actions/checkout@v2

    # ç¬¬2æ­¥: æŸ¥æ‰¾æ‰€æœ‰ä¸ proxy.dll ç›¸å…³çš„æ–‡ä»¶å¹¶è¿›è¡Œé‡å‘½åå’Œç§»åŠ¨
    - name: ç§»åŠ¨å¹¶é‡å‘½åæ–‡ä»¶ ğŸ“‚
      run: |
        for f in $(find . -type f \( -iname proxy.dll -o -iname Proxy.dll \) ! -path "./files/proxy.dll"); do
            echo "Found file: $f"
            echo "Copying file $f to files/proxy.dll"
            cp $f files/proxy.dll
            echo "Removing original file: $f"
            rm -v "$f"
        done

    # ç¬¬3æ­¥: æ£€æŸ¥æ–‡ä»¶å¤§å°å¹¶å†³å®šæ˜¯å¦ç»§ç»­
    - name: æ£€æŸ¥æ–‡ä»¶å¤§å° ğŸ”
      run: |
        filesize=$(stat --printf="%s" files/proxy.dll)
        if [[ $filesize -gt 15728640 ]]; then
          echo "ğŸ“¦ proxy.dll æ–‡ä»¶å¤§äº 15MBï¼Œå‡†å¤‡è®¡ç®— MD5ã€‚"
          echo "PROCEED=true" >> $GITHUB_ENV
        else
          echo "âŒ proxy.dll æ–‡ä»¶ä¸è¶…è¿‡ 15MBï¼Œé€€å‡ºæµç¨‹ã€‚"
          echo "PROCEED=false" >> $GITHUB_ENV
        fi

    # ç¬¬4æ­¥: å¦‚æœæ–‡ä»¶å¤§äº15MBï¼Œè®¡ç®—å…¶ MD5 å“ˆå¸Œå¹¶è¾“å‡ºåˆ° core.json æ–‡ä»¶
    - name: è®¡ç®— MD5 å¹¶è¾“å‡ºåˆ° core.json æ–‡ä»¶ ğŸ› ï¸
      if: env.PROCEED == 'true'
      run: |
        md5=$(md5sum files/proxy.dll | awk '{ print $1 }')
        echo "âœ… æ–‡ä»¶çš„ MD5 å€¼ä¸º: $md5"
        rm -f core.json
        echo "{\"md5\": \"$md5\"}" > core.json

    # ç¬¬5æ­¥: æäº¤å¹¶æ¨é€ MD5 æ›´æ–°
    - name: æäº¤å¹¶æ¨é€ MD5 æ›´æ–° â¬†ï¸
      if: env.PROCEED == 'true'
      run: |
        current_datetime=$(date '+%Y-%m-%d %H:%M:%S')
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰ä»»ä½•æ›´æ”¹ï¼Œè·³è¿‡æäº¤å’Œæ¨é€æ­¥éª¤ã€‚"
        else
          git commit -m "ä½¿ç”¨ MD5 å“ˆå¸Œå€¼æ›´æ–° core.json æ–‡ä»¶ - $current_datetime"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/WizisCool/KiKHanbot.git
        fi
